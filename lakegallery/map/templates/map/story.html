{% extends 'map/base.html' %}
{% load leaflet_tags %}

{% block content %}
  <div class="container-fluid">
    <div class="row">
      <div class="col-4 contentPanel">
        <h2>{{ lake }} Story Map</h2>
        <p>{{ story.summary }}</p>
        <h2>History of {{ lake }}</h2>
        <p>{{ story.history }}</p>
        <h2>{{ story.section_one_header }}</h2>
        <p>{{ story.section_one_content }}</p>
        <h2>{{ story.section_two_header }}</h2>
        <p>{{ story.section_two_content }}</p>
        <h2>{{ story.section_three_header }}</h2>
        <p>{{ story.section_three_content }}</p>
      
      </div>
      <div class="col-8 mapPanel">
        <input id="historicalSlider" type="text" style="display:none;"/>
        {% leaflet_map "storyMap" callback="main_map_init" %}
        <script type="text/javascript">
            
            function main_map_init (map, options) {
              var basemaps = {
                  'Google Imagery': L.tileLayer.wms('https://txgi.tnris.org/login/path/source-blonde-xray-cheese/wms', {
                      layers: 'texas',
                      attribution: 'Google'
                  })

                  // ,'Grayscale': L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}@2x.png')
              };

              var layerController = L.control.layers(basemaps);
              layerController.addTo(map);
              basemaps['Google Imagery'].addTo(map);


              var account = 'tnris-flood'
              var tileLayer;

              var resConfig = JSON.parse('{{ layer }}'.replace(/&#39;/g, '"').replace(/&quot;/g, "'"));
              var linkConfig = JSON.parse('{{ links }}'.replace(/&#39;/g, '"'));

              function getTileUrls (config, lakeName) {
                var css = config.carto_css;
                // var interactivity = config.interactivity;
                var sql = `select * from ${config.table_name} where res_lbl = '${lakeName}'`;

                $.ajax({
                  crossOrigin: true,
                  type: 'GET',
                  dataType: 'json',
                  contentType: 'application/json',
                  url: `/api/reservoirs/${lakeName}/name`,
                  success: function(data) {
                    var bb = data.results.features[0].bbox;
                    map.flyToBounds([[bb[1],bb[0]],[bb[3],bb[2]]]);
                  }
                })

                var mapconfig = {
                  "version": "1.3.1",
                  "layers": [{
                    "type": "mapnik",
                    "options": {
                      "cartocss_version": "2.1.1",
                      "cartocss": css,
                      "sql": sql
                      // "interactivity": interactivity
                    }
                  }]
                }

                $.ajax({
                  crossOrigin: true,
                  type: 'POST',
                  dataType: 'json',
                  contentType: 'application/json',
                  url: `https://${account}.carto.com/api/v1/map`,
                  data: JSON.stringify(mapconfig),
                  success: function(data) {
                    var url = `https://${account}.carto.com/api/v1/map/` + data.layergroupid + '/{z}/{x}/{y}.png'
                    tileLayer = new L.tileLayer(url);
                    tileLayer.addTo(map);
                    layerController.addOverlay(tileLayer, '{{ lake }}');


                  }
                })
              }




              getTileUrls(resConfig, "{{ lake }}");
              
              console.log("{{ lake }}");


              function setupHistoricalSlider(links) {
                

                var ticks = [0];
                var labels = ['Off'];
                links.map(function(l, index) {
                  ticks.push(index + 1);
                  labels.push(l.year);
                });
                var len = ticks.length;
                
                $("#historicalSlider").slider({
                  ticks: ticks,
                  ticks_labels: labels,
                  ticks_snap_bounds: 1,
                  value: 0
                });
                var active = false;
                var secondBasemap;
                var historicalLayer;
                var sideBySideControl;
                $("#historicalSlider").on('slideStop', function(e) {
                  if (active == true) {
                    map.removeLayer(secondBasemap);
                    map.removeLayer(historicalLayer);
                    map.removeControl(sideBySideControl);
                  }
                  if (e.value != 0) {
                    secondBasemap = L.tileLayer.wms('https://txgi.tnris.org/login/path/source-blonde-xray-cheese/wms', {
                        layers: 'texas',
                        attribution: 'Google'
                      }).addTo(map);
                    var position = e.value - 1;
                    historicalLayer = L.esri.tiledMapLayer({'url':linkConfig[position]['link']}).addTo(map);
                    sideBySideControl = L.control.sideBySide(basemaps['Google Imagery'], [secondBasemap, historicalLayer]).addTo(map);
                    active = true;
                  }
                });

              }
              if (linkConfig.length > 0) {
                $("#historicalSlider").css('display', 'block');
                setupHistoricalSlider(linkConfig);
              }
            }

            
        </script>
      </div>
    </div>
  </div>
{% endblock %}