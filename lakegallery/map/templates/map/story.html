{% extends 'map/base.html' %}
{% load leaflet_tags %}

{% block content %}
    {% leaflet_map "main" callback="main_map_init" %}
    <script type="text/javascript">
        function main_map_init (map, options) {
          var account = 'tnris-flood'
          var tileLayer;

          var resConfig = JSON.parse('{{ layer }}'.replace(/&#39;/g, '"').replace(/&quot;/g, "'"));

          function getTileUrls (config, lakeName) {
            var css = config.carto_css;
            // var interactivity = config.interactivity;
            var sql = `select * from ${config.table_name} where res_lbl = '${lakeName}'`;

            $.ajax({
              crossOrigin: true,
              type: 'GET',
              dataType: 'json',
              contentType: 'application/json',
              url: `/api/reservoirs/${lakeName}/name`,
              success: function(data) {
                var bb = data.results.features[0].bbox;
                map.flyToBounds([[bb[1],bb[0]],[bb[3],bb[2]]]);
              }
            })

            var mapconfig = {
              "version": "1.3.1",
              "layers": [{
                "type": "mapnik",
                "options": {
                  "cartocss_version": "2.1.1",
                  "cartocss": css,
                  "sql": sql
                  // "interactivity": interactivity
                }
              }]
            }

            $.ajax({
              crossOrigin: true,
              type: 'POST',
              dataType: 'json',
              contentType: 'application/json',
              url: `https://${account}.carto.com/api/v1/map`,
              data: JSON.stringify(mapconfig),
              success: function(data) {
                var url = `https://${account}.carto.com/api/v1/map/` + data.layergroupid + '/{z}/{x}/{y}.png'
                tileLayer = new L.tileLayer(url);
                tileLayer.addTo(map);
              }
            })
          }

          getTileUrls(resConfig, "{{ lake }}");
          console.log("{{ lake }}");
        }
    </script> 
{% endblock %}