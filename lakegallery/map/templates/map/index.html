{% extends 'map/base.html' %}
{% load leaflet_tags %}

{% block content %}
    {% leaflet_map "main" callback="main_map_init" %}
    <script type="text/javascript">
        function main_map_init (map, options) {
          L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}@2x.png').addTo(map);
          var account = 'tnris-flood'
          // var tooltip;
          var tileLayer;
          var utfGrid;
          var outlineLayer;

          var rwpasConfig = JSON.parse('{{ layers.rwpas }}'.replace(/&#39;/g, '"').replace(/&quot;/g, "'"));
          var resConfig = JSON.parse('{{ layers.reservoirs }}'.replace(/&#39;/g, '"').replace(/&quot;/g, "'"));

          function focusRegion (regionLetter) {
            var regionLink = '/' + regionLetter;
            window.history.pushState({"url": regionLink}, "Region", regionLink);
            map.eachLayer(function (layer) {
              map.removeLayer(tileLayer);
              map.removeLayer(utfGrid);
              getTileUrls(resConfig, regionLetter);
            });
          }

          function getTileUrls (config, regionLetter) {
            var css = config.carto_css;
            css += config.carto_lbl;
            var interactivity = config.interactivity;
            
            var sql = `select * from ${config.table_name}`;
            if (regionLetter) {
              sql = `select * from ${config.table_name} where region= '${regionLetter}'`;

              $.ajax({
                crossOrigin: true,
                type: 'GET',
                dataType: 'json',
                contentType: 'application/json',
                url: `/api/rwpas/${regionLetter}/region`,
                success: function(data) {
                  var bb = data.results.features[0].bbox;
                  map.flyToBounds([[bb[1],bb[0]],[bb[3],bb[2]]]);
                }
              })

              var outlineconfig = {
                "version": "1.3.1",
                "layers": [{
                  "type": "mapnik",
                  "options": {
                    "cartocss_version": "2.1.1",
                    "cartocss": '#layer::outline {line-width: 1;line-color: #bc6400;line-opacity: 1;}',
                    "sql": `select * from rwpas where letter = '${regionLetter}'`,
                  }
                }]
              }

              $.ajax({
                crossOrigin: true,
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                url: `https://${account}.carto.com/api/v1/map`,
                data: JSON.stringify(outlineconfig),
                success: function(data) {
                  var url = `https://${account}.carto.com/api/v1/map/` + data.layergroupid + '/{z}/{x}/{y}.png'
                  outlineLayer = new L.tileLayer(url);
                  outlineLayer.addTo(map);
                }
              })


            }

            var mapconfig = {
              "version": "1.3.1",
              "layers": [{
                "type": "mapnik",
                "options": {
                  "cartocss_version": "2.1.1",
                  "cartocss": css,
                  "sql": sql,
                  "interactivity": interactivity
                }
              }]
            }

            $.ajax({
              crossOrigin: true,
              type: 'POST',
              dataType: 'json',
              contentType: 'application/json',
              url: `https://${account}.carto.com/api/v1/map`,
              data: JSON.stringify(mapconfig),
              success: function(data) {
                var url = `https://${account}.carto.com/api/v1/map/` + data.layergroupid + '/{z}/{x}/{y}.png'
                tileLayer = new L.tileLayer(url);
                tileLayer.addTo(map);

                var gridUrl = `https://${account}.carto.com/api/v1/map/` + data.layergroupid + '/0/{z}/{x}/{y}.grid.json'
                utfGrid = new L.utfGrid(gridUrl);
                utfGrid.on('mouseover', function (e) {
                  $('.leaflet-container').css('cursor', 'pointer');
                  // utfGrid.setTooltipContent(e.data[config.label_field]);
                });
                utfGrid.on('mouseout', function (e) {
                  $('.leaflet-container').css('cursor', '');
                });
                utfGrid.on('click', function (e) {
                  if (e.data) {
                    if (e.data.letter != null) {
                      focusRegion(e.data.letter);
                    }
                    else if (e.data.res_lbl) {
                      // handle jump to reservoir story here
                      var name = encodeURIComponent(e.data.res_lbl);
                      window.location.href = `/${e.data.region}/${name}`
                    }
                  }
                });
                // utfGrid.bindTooltip("", {sticky: true}).addTo(map);
                utfGrid.addTo(map);
              }
            })
          }

          if ("{{ region }}" == "") {
            getTileUrls(rwpasConfig);
          } else {
            getTileUrls(resConfig, "{{ region }}");
          }
        }
        $(window).on("popstate", function(e) {
            window.location.href = "/";
          });
        
    </script> 
{% endblock %}