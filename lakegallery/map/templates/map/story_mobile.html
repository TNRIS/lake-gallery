{% extends 'map/base.html' %}
{% load leaflet_tags %}
{% load static %}

{% block content %}
  <div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-body">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <img src="" class="imagepreview" />
          <p class="imagepreview-caption" style="font-style: italic;"></p>
        </div>
      </div>
    </div>
  </div>
  <div class="container" id="mobileContainer">
    <div class="row">
      <div class="togglerWrapper">
        <button class="btn" type="button" data-toggle="collapse" data-target="#mobileStoryPanelContainer" aria-expanded="false" aria-controls="mobileStoryPanelContainer" id="mobileStoryToggler">
          <img id="togglerImg" class="closed" src="{% static 'map/images/arrow-down.png' %}"/>
        </button>
      </div>
      <div class="collapse" id="mobileStoryPanelContainer">
        <div class="col-12 mobileStoryPanel">
          <div id="mobileCarouselIndicators" class="carousel slide" data-ride="carousel" data-interval="false">
            <ol class="carousel-indicators">
              <li data-target="#mobileCarouselIndicators" class="active"></li>
              {% if story.history %}
                <li data-target="#mobileCarouselIndicators"></li>
              {% endif %}
              {% if stats.general_stats %}
                <li data-target="#mobileCarouselIndicators"></li>
              {% endif %}
              {% if story.section_one_header %}
                <li data-target="#mobileCarouselIndicators"></li>
              {% endif %}
              {% if story.section_two_header %}
                <li data-target="#mobileCarouselIndicators"></li>
              {% endif %}
              {% if story.section_three_header %}
                <li data-target="#mobileCarouselIndicators"></li>
              {% endif %}
            </ol>
            <div class="carousel-inner" role="listbox">
              <div class="carousel-item active">
                <div class="mobileStoryPage">
                  <h2 class="mobilePageHeader" id="Overview">{{ lake }}</h2>
                  <div>{{ story.summary|safe }}</div>
                </div>
              </div>
              {% if story.history %}
                <div class="carousel-item">
                  <div class="mobileStoryPage">
                    <h2 class="mobilePageHeader" id="History">{{ lake }} History</h2>
                    <div>{{ story.history|safe }}</div>
                  </div>
                </div>
              {% endif %}
              {% if stats.general_stats %}
                <div class="carousel-item">
                  <div class="mobileStoryPage">
                    <h2 class="mobilePageHeader" id="Statistics">{{ lake }} Statistics</h2>
                    <ul class="statsList">
                      {% if stats.original_name not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Original Name:</span>
                          {{ stats.original_name }}
                        </li>
                      {% endif %}
                      {% if stats.primary_purposes not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Primary Purposes:</span>
                          {{ stats.primary_purposes }}
                        </li>
                      {% endif %}
                      {% if stats.location not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Location:</span>
                          {{ stats.location }}
                        </li>
                      {% endif %}
                      {% if stats.construction_dates not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Construction Dates:</span>
                          {{ stats.construction_dates }}
                        </li>
                      {% endif %}
                      {% if stats.length_of_lake not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Length of Lake:</span>
                          {{ stats.length_of_lake }} miles
                        </li>
                      {% endif %}
                      {% if stats.miles_of_shoreline not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Miles of Shoreline:</span>
                          {{ stats.miles_of_shoreline }} miles
                        </li>
                      {% endif %}
                      {% if stats.maximum_width not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Maximum Width:</span>
                          {{ stats.maximum_width }} miles
                        </li>
                      {% endif %}
                      {% if stats.lake_area not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Lake Area:</span>
                          {{ stats.lake_area }} acres
                        </li>
                      {% endif %}
                      {% if stats.lake_capacity not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Lake Capacity:</span>
                          {{ stats.lake_capacity }} acre-feet
                        </li>
                      {% endif %}
                      {% if stats.full_elevation_msl not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Full Elevation:</span>
                          {{ stats.full_elevation_msl }} mean sea level (msl) ({{ stats.full_elevation_gal }} gallons of water)
                        </li>
                      {% endif %}
                      {% if stats.maximum_depth not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Maximum Depth:</span>
                          {{ stats.maximum_depth }} ft
                        </li>
                      {% endif %}
                      {% if stats.average_depth not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Average Depth:</span>
                          {{ stats.average_depth }} ft
                        </li>
                      {% endif %}
                      {% if stats.historic_high_msl not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Historic High:</span>
                          {{ stats.historic_high_msl }} feet msl on {{ stats.historic_high_date }}
                        </li>
                      {% endif %}
                      {% if stats.historic_low_msl not in stats.stat_defaults %}
                        <li>
                          <span class="statLabel">Historic Low:</span>
                          {{ stats.historic_low_msl }} feet msl on {{ stats.historic_low_date }}
                        </li>
                      {% endif %}
                    </ul>
                    {% if stats.dam_stats %}
                      <h5>Dam Statistics</h5>
                      <ul class="statsList">
                        {% if stats.dam_height not in stats.stat_defaults %}
                          <li>
                            <span class="statLabel">Dam Dimensions:</span>
                            {{ stats.dam_height }} feet high, {{ stats.dam_width }} feet long
                          </li>
                        {% endif %}
                        {% if stats.spillway_elevation not in stats.stat_defaults %}
                          <li>
                            <span class="statLabel">Spillway Elevation:</span>
                            {{ stats.spillway_elevation }} feet above msl
                          </li>
                        {% endif %}
                        {% if stats.top_of_dam not in stats.stat_defaults %}
                          <li>
                            <span class="statLabel">Top of Dam:</span>
                            {{ stats.top_of_dam }} feet above msl
                          </li>
                        {% endif %}
                        {% if stats.num_of_floodgates not in stats.stat_defaults %}
                          <li>
                            <span class="statLabel">Number of Floodgates:</span>
                            {{ stats.num_of_floodgates }}
                          </li>
                        {% endif %}
                        {% if stats.discharge_capacity not in stats.stat_defaults %}
                          <li>
                            <span class="statLabel">Total Discharge Capacity:</span>
                            <br />
                            {{ stats.discharge_capacity|safe }}
                          </li>
                        {% endif %}
                      </ul>
                    {% endif %}
                    {% if stats.wdft_link %}
                      <h5>Current Conditions</h5>
                      <img class="picZoom" src="{{ stats.wdft_link }}/recent-volume.png" />
                      <p style="text-align: center;">View all current conditions at <a href="{{ stats.wdft_link }}" target="wdft">waterdatafortexas.org</a></p>
                    {% endif %}

                    {% if high_events|length > 0 %}
                      <h5 class="rankedHeader">Top {{ high_events|length }} Highest Lake Levels</h5>
                      <table class="table rankedEvents">
                        <thead>
                          <tr>
                            <th>Rank</th>
                            <th>Date</th>
                            <th>Height*</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for e in high_events %}
                            <tr>
                              <th scope="row">{{ e.rank }}</th>
                              <td>{{ e.date }}</td>
                              <td>{{ e.height }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% endif %}
                    {% if low_events|length > 0 %}
                      <h5 class="rankedHeader">Top {{ low_events|length }} Lowest Lake Levels</h5>
                      <table class="table rankedEvents">
                        <thead>
                          <tr>
                            <th>Rank</th>
                            <th>Drought</th>
                            <th>Date</th>
                            <th>Height*</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for e in low_events %}
                            <tr>
                              <th scope="row">{{ e.rank }}</th>
                              <td>{{ e.drought }}</td>
                              <td>{{ e.date }}</td>
                              <td>{{ e.height }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% endif %}
                    {% if low_events|length > 0 or high_events|length > 0 %}
                      <p id="rankingFooter">*Height is represented as feet above mean sea level (MSL)</p>
                    {% endif %}
                  </div>

                </div>
              {% endif %}

              {% if story.section_one_header %}
                <div class="carousel-item">
                  <div class="mobileStoryPage">
                    <h2 class="mobilePageHeader" id="{{ story.section_one_nav|cut:' ' }}">{{ story.section_one_header }}</h2>
                    <div>{{ story.section_one_content|safe }}</div>
                  </div>
                </div>
              {% endif %}

              {% if story.section_two_header %}
                <div class="carousel-item">
                  <div class="mobileStoryPage">
                    <h2 class="mobilePageHeader" id="{{ story.section_two_nav|cut:' ' }}">{{ story.section_two_header }}</h2>
                    <div>{{ story.section_two_content|safe }}</div>
                  </div>
                </div>
              {% endif %}

              {% if story.section_three_header %}
                <div class="carousel-item">
                  <div class="mobileStoryPage">
                    <h2 class="mobilePageHeader" id="{{ story.section_three_nav|cut:' ' }}">{{ story.section_three_header }}</h2>
                    <div>{{ story.section_three_content|safe }}</div>
                  </div>
                </div>
              {% endif %}
            </div>
            <!-- <a class="carousel-control-prev" href="#mobileCarouselIndicators" role="button" data-slide="prev">
              <p>
                <img src="{% static 'map/images/glyphicons-arrow-left.png' %}"/>
                <span class="sr-only">Previous</span>
              </p>
            </a>
            <a class="carousel-control-next" href="#mobileCarouselIndicators" role="button" data-slide="next">
              <p>
                <img src="{% static 'map/images/glyphicons-arrow-right.png' %}"/>
                <span class="sr-only">Next</span>
              </p>
            </a> -->
          </div>


        </div>
      </div>
      <div class="col-12 mobileMapPanel">

        <!-- story map tools menu - time slider and lake outline, etc -->
        <div id="slider-container-mobile" style="display: none;">

          <div class="slider-container-header">
            <img src="{% static 'map/images/camera-solid.svg' %}" style="width:20px; height:20px; margin-right:10px;" alt="camera-icon" />
            <p>View <strong>{{ lake }}</strong> - Past to Present</p>
          </div>

          <div style="width:auto; min-height:40px; padding:0 10px 0 10px; text-align:center;">
            <input id='historicalSlider' type='text'/>
          </div>

          <hr class="separator"></hr>

          <div class="slider-container-text bottom-container">

            <div class="centering-div">
              <div style="float:left;">
                <a id="zoom-extent" href="#" class="link">
                  <img class="extent" src="{% static 'map/images/extent.png' %}" />
                </a>
                <span>Full Lake Extent</span>
              </div>

              <div style="float:right;">
                <div style="padding-top:5px; float:left; vertical-align:baseline; margin-right:3px;">
                  <input type="checkbox" id="lakeOverlay" name="overlay" value="checked" checked />
                </div>
                <label for="lakeOverlay">Lake Outline</label>
              </div>
            </div>

          </div>

        </div>

        {% leaflet_map "mobileStoryMap" callback="main_map_init" %}

        <script type="text/javascript">

            function main_map_init (map, options) {
              var basemaps = {
                  'Google Imagery': new L.TileLayer.WMTS('https://txgi.tnris.org/login/path/source-blonde-xray-cheese/wmts', {
                      layer: 'texas',
                      style: "default",
                      tilematrixSet: "0to20",
                      format: "image/png",
                      attribution: '<a href="https://tnris.org/texas-imagery-service/" target="_blank">Google</a>'
                  })

              };

              var lakeLayer;

              basemaps['Google Imagery'].addTo(map);

              var account = 'tnris-flood';

              var resConfig = JSON.parse('{{ layer }}'.replace(/&#39;/g, '"').replace(/&quot;/g, "'"));
              var linkConfig = JSON.parse('{{ links }}'.replace(/&#39;/g, '"'));

              // begin getLakeJson function - config & lakeName as args
              function getLakeJson (config, lakeName) {
                var css = config.carto_story_css;
                var interactivity = config.interactivity;
                var sql = `SELECT * FROM ${config.table_name} WHERE story='enabled' AND res_lbl = '${lakeName}'`;
                var bb = {{ extent }};

                var lakeBounds = [[bb[1],bb[0]],[bb[3],bb[2]]];

                var url = `https://${account}.carto.com/api/v2/sql?format=GeoJSON&q=${sql}`;

                // add geojson lake layer with simple popup
                $.getJSON(url, function(data) {
                  lakeLayer = L.geoJson(data, {
                    onEachFeature: function (feature, layer) {
                      layer.bindPopup(feature.properties.res_lbl);
                    }
                  }).addTo(map);
                });

                // fit map to bounds of lake layer (lakeBounds)
                map.fitBounds(lakeBounds);

                // set max zoom level minus one to give some extra room
                var maxZoomLevel = map.getZoom() - 1;
                map.options.minZoom = maxZoomLevel;

                // set max bounds to lakeBounds so user can't pan outside of lake area
                // padding added to bounds so max is not too restrictive
                map.setMaxBounds(map.getBounds(lakeBounds).pad(0.2));

              } // end getLakeJson function

              // run getLakeJson function with resConfig & lake name as args
              getLakeJson(resConfig, "{{ lake }}");

              // Historical slider function below -----
              function setupHistoricalSlider(links) {
                var topNaip = [];
                var ticks = [];
                var labelObject = {};

                links.map(function(l, index) {
                  ticks.push(index);
                  labelObject[index] = l.year;

                  if (l.year == '2015' || l.year == '2016') {
                    topNaip.push(index);
                  }
                });

                var len = ticks.length;
                labelObject[len] = `<a href="https://tnris.org/texas-imagery-service/"
                                      target="_blank"
                                      title="Texas Imagery Service">
                                        <img class="google-logo" src={% static 'map/images/google-22px.png' %} />
                                    </a>`;
                ticks.push(len);

                // create labels for time slider with links to datahub historical imagery
                var labelArray = [];
                var positionArray = [];

                Object.values(labelObject).forEach(function (value) {
                  // value != 'Current' ? labelArray.push(`<a href="#" target="_blank" class="historical-link" title="get it on datahub">${value}</a>`)
                  value != 'Current' ? labelArray.push(value)
                  : labelArray.push('Current');
                });
                // end label array function

                // create positionArray; used to position labels below ticks
                var positionArray = [];

                if (labelArray.length > 1) {
                  var positionInterval = 100 / (labelArray.length - 1);

                  for (i=0; i < labelArray.length; i++) {
                    positionArray.push(positionInterval * i);
                  }
                };
                // end positionArray

                $("#historicalSlider").slider({
                  value: len,
                  ticks: ticks,
                  ticks_labels: labelArray,
                  ticks_positions: positionArray
                });

                var slideStart;
                var active = false;
                var secondBasemap;
                var historicalLayer;
                var sideBySideControl;

                $("#historicalSlider").on('change', function(e) {
                  slideStart = e.value.oldValue;
                });

                $("#historicalSlider").on('slideStop', function(e) {
                  if (active == true) {
                    map.removeLayer(secondBasemap);
                    map.removeLayer(historicalLayer);
                    map.removeControl(sideBySideControl);
                  }

                  if (e.value != (ticks.length - 1)) {
                    if (slideStart == (ticks.length - 1)) {
                      lakeLayer.remove();
                      document.getElementById("lakeOverlay").checked = false;
                    }

                    secondBasemap = new L.TileLayer.WMTS('https://txgi.tnris.org/login/path/source-blonde-xray-cheese/wmts', {
                      layer: 'texas',
                      style: "default",
                      tilematrixSet: "0to20",
                      format: "image/png"
                    }).addTo(map);

                    var position = e.value;

                    if (topNaip.indexOf(position) != -1) {
                      historicalLayer = L.tileLayer.wms(linkConfig[position]['link'], {layers: '0'}).addTo(map);
                    }
                    else {
                      historicalLayer = L.esri.tiledMapLayer({'url':linkConfig[position]['link']}).addTo(map);
                    }

                    sideBySideControl = L.control.sideBySide(basemaps['Google Imagery'], [secondBasemap, historicalLayer]).addTo(map);
                    active = true;

                    $('input.leaflet-sbs-range').mousedown(function(e){
                        e.stopPropagation();
                    });
                  }
                });
              } // end of setupHistoricalSlider function

              if (linkConfig.length > 0) {
                setupHistoricalSlider(linkConfig);
              }

              // custom easy button control to turn off and on container div w/ time slider
              window.customEasyBtn = L.easyButton({
                position: 'topright',
                id: 'customEasyBtn',
                states: [
                  {
                    stateName: 'closed',
                    icon: "<img class='menu-icon' src={% static 'map/images/menu.svg' %} />",
                    title: 'Open tools menu',
                    onClick: function(control){
                      control.state('open');
                      $("#slider-container-mobile").fadeToggle();
                    }
                  },
                  {
                    stateName: 'open',
                    icon: "<img class='menu-icon' src={% static 'map/images/menu-close.svg' %} />",
                    title: 'Close tools menu',
                    onClick: function(control) {
                      control.state('closed');
                      $("#slider-container-mobile").fadeToggle();
                    }
                  }
                ]
              }).addTo(map);

              // set the easy button default state based on screen size & display or hide the custom control
              window.innerWidth > 991 ?
                window.customEasyBtn.state('open') && $("#slider-container-mobile").fadeToggle() :
                window.customEasyBtn.state('closed');

              // lake polygon overlay input checkbox function - inside custom time slider/layer control
              var checkbox = document.getElementById("lakeOverlay");
              checkbox.addEventListener("click", function() {
                checkbox.checked ? lakeLayer.addTo(map) : lakeLayer.remove();
              });

              // zoom to lake extent function in story map - inside custom time slider/layer control
              var extentControl = document.getElementById("zoom-extent");
              extentControl.addEventListener("click", function() {
                map.fitBounds(lakeLayer.getBounds());
              });

            } // end of main_map_init function

            // below are general functions available outside main_map_init

            // setup picture modal event to populate image in modal dynamically
            $(function() {
                $('.picZoom').on('click', function() {
                  $('.imagepreview').attr('src', $(this)[0]['src']);
                  $('.imagepreview-caption').html($(this).next().html());
                  $('#imagemodal').modal('show');
                });

                // swap out story toggler icon for map button
                $('#mobileStoryToggler').on('click', function() {
                  var img = $('#togglerImg');
                  var className = img[0]['className'];
                  var static_url = "{% static 'map/images/' %}";
                  if (className == 'closed') {
                    img.attr('src', static_url + "arrow-up.png");
                    img.removeClass('closed');
                  }
                  else {
                    img.attr('src', static_url + "arrow-down.png");
                    img.addClass('closed');
                  }
                });

                // enable swipe on carousel
                var carouselElement = document.getElementById("mobileCarouselIndicators");
                var hammertime = new Hammer(carouselElement);
                hammertime.on('swipe', function(ev) {
                  if (ev.direction == 2) {
                    $("#mobileCarouselIndicators").carousel('next');
                  }
                  else if (ev.direction == 4) {
                    $("#mobileCarouselIndicators").carousel('prev');
                  }
                });
            });
        </script>
      </div>
    </div>
  </div>
{% endblock %}
